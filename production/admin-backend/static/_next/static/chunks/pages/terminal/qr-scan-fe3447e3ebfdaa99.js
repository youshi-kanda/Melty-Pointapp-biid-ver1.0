(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[5546],{3924:function(e,s,t){(window.__NEXT_P=window.__NEXT_P||[]).push(["/terminal/qr-scan",function(){return t(2562)}])},2562:function(e,s,t){"use strict";t.r(s),t.d(s,{default:function(){return h}});var a=t(5893),r=t(645),n=t.n(r),l=t(7294),d=t(1163),i=t(9008),c=t.n(i),x=t(2190),o=t(341),m=t(4420),b=t(3050),f=t(8655),u=t(6916),j=t(1508);function h(){let e=(0,d.useRouter)(),[s,t]=(0,l.useState)("scan"),[r,i]=(0,l.useState)("waiting"),[h,g]=(0,l.useState)(""),[N,p]=(0,l.useState)(30),[y,w]=(0,l.useState)("prompt"),v=(0,l.useRef)(null),_=(0,l.useRef)(!1),[E,R]=(0,l.useState)(""),[k,S]=(0,l.useState)(null);(0,l.useEffect)(()=>{R(JSON.stringify({type:"terminal_auth",sessionId:"TERMINAL_".concat(Date.now(),"_").concat(Math.random().toString(36).substr(2,9)),timestamp:Date.now()}))},[]),(0,l.useEffect)(()=>{if("display"===s&&!k){let e=setInterval(()=>{},3e3);return()=>clearInterval(e)}},[s,k,E]),(0,l.useEffect)(()=>{k&&(i("success"),setTimeout(()=>{e.push("/terminal/customer-confirm?userId=".concat(k))},1500))},[k,e]),(0,l.useEffect)(()=>{if("scan"===s&&("waiting"===r||"scanning"===r)&&N>0){let e=setTimeout(()=>p(N-1),1e3);return()=>clearTimeout(e)}"scan"===s&&0===N&&"success"!==r&&(i("error"),g("タイムアウトしました"),Q())},[N,r,s]),(0,l.useEffect)(()=>{if("scan"===s&&!_.current)return(async()=>{try{(await navigator.mediaDevices.getUserMedia({video:!0})).getTracks().forEach(e=>e.stop()),w("granted"),_.current=!0;let s=new u.t2("qr-reader");v.current=s,await s.start({facingMode:"environment"},{fps:10,qrbox:{width:250,height:250}},s=>{i("success"),Q();let t=C(s);setTimeout(()=>{e.push("/terminal/customer-confirm?userId=".concat(t))},1500)},e=>{}),i("scanning")}catch(e){console.error("カメラ初期化エラー:",e),"NotAllowedError"===e.name||"PermissionDeniedError"===e.name?(w("denied"),g("カメラの使用が許可されていません。ブラウザの設定でカメラへのアクセスを許可してください。")):"NotFoundError"===e.name?g("カメラが見つかりません。デバイスにカメラが接続されているか確認してください。"):g("カメラの初期化に失敗しました。手動入力をご利用ください。"),i("error")}})(),()=>{Q()}},[e,s]);let C=e=>{try{if(e.startsWith("USER:"))return e.replace("USER:","");if(!e.startsWith("{"))return e;{let s=JSON.parse(e);return s.userId||s.id||e}}catch(s){return e}},Q=()=>{v.current&&(v.current.stop().catch(e=>console.error("スキャナー停止エラー:",e)),v.current=null)},q=()=>{e.push("/terminal/")},z=()=>{Q(),e.push("/terminal/manual-input")},T=e=>{e!==s&&("scan"===s&&(Q(),_.current=!1),t(e),i("waiting"),p(30),g(""),S(null))};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(c(),{children:(0,a.jsx)("title",{children:"QRスキャン - Melty+ Terminal"})}),(0,a.jsxs)("div",{className:"jsx-97ad73b43520455f min-h-screen bg-gradient-to-br from-blue-50 to-blue-100 flex flex-col",children:[(0,a.jsx)("div",{className:"jsx-97ad73b43520455f bg-gradient-to-r from-blue-600 to-blue-500 text-white px-4 sm:px-6 py-3 shadow-md",children:(0,a.jsxs)("div",{className:"jsx-97ad73b43520455f max-w-4xl mx-auto flex items-center justify-between",children:[(0,a.jsx)("h1",{className:"jsx-97ad73b43520455f text-lg sm:text-xl font-bold",children:"ユーザー認証"}),(0,a.jsxs)("button",{onClick:q,className:"jsx-97ad73b43520455f flex items-center gap-2 bg-white/20 hover:bg-white/30 px-3 py-1.5 rounded-lg transition-colors",children:[(0,a.jsx)(x.Z,{size:18}),(0,a.jsx)("span",{className:"jsx-97ad73b43520455f text-sm",children:"キャンセル"})]})]})}),(0,a.jsx)("div",{className:"jsx-97ad73b43520455f bg-white border-b border-gray-200 px-4 py-2",children:(0,a.jsxs)("div",{className:"jsx-97ad73b43520455f max-w-4xl mx-auto flex gap-2",children:[(0,a.jsxs)("button",{onClick:()=>T("scan"),className:"jsx-97ad73b43520455f "+"flex-1 flex items-center justify-center gap-2 py-3 px-4 rounded-lg font-medium transition-all ".concat("scan"===s?"bg-blue-600 text-white shadow-md":"bg-gray-100 text-gray-600 hover:bg-gray-200"),children:[(0,a.jsx)(o.Z,{size:20}),(0,a.jsx)("span",{className:"jsx-97ad73b43520455f",children:"QRスキャン"})]}),(0,a.jsxs)("button",{onClick:()=>T("display"),className:"jsx-97ad73b43520455f "+"flex-1 flex items-center justify-center gap-2 py-3 px-4 rounded-lg font-medium transition-all ".concat("display"===s?"bg-blue-600 text-white shadow-md":"bg-gray-100 text-gray-600 hover:bg-gray-200"),children:[(0,a.jsx)(m.Z,{size:20}),(0,a.jsx)("span",{className:"jsx-97ad73b43520455f",children:"QR表示"})]})]})}),(0,a.jsx)("div",{className:"jsx-97ad73b43520455f flex-1 flex items-center justify-center p-4",children:(0,a.jsxs)("div",{className:"jsx-97ad73b43520455f max-w-md w-full",children:["scan"===s?(0,a.jsx)("div",{className:"jsx-97ad73b43520455f bg-gray-900 rounded-xl overflow-hidden mb-4 shadow-2xl",children:(0,a.jsxs)("div",{className:"jsx-97ad73b43520455f aspect-square relative",children:[(0,a.jsx)("div",{id:"qr-reader",className:"jsx-97ad73b43520455f w-full h-full"}),"success"===r&&(0,a.jsx)("div",{className:"jsx-97ad73b43520455f absolute inset-0 bg-green-500/20 flex items-center justify-center",children:(0,a.jsx)("div",{className:"jsx-97ad73b43520455f bg-green-500 text-white px-6 py-3 rounded-lg font-bold shadow-xl",children:"読み取り成功！"})}),"error"===r&&(0,a.jsx)("div",{className:"jsx-97ad73b43520455f absolute inset-0 bg-red-500/20 flex items-center justify-center",children:(0,a.jsx)("div",{className:"jsx-97ad73b43520455f bg-red-500 text-white px-6 py-3 rounded-lg font-bold shadow-xl",children:"読み取りエラー"})})]})}):(0,a.jsx)("div",{className:"jsx-97ad73b43520455f bg-white rounded-xl overflow-hidden mb-4 shadow-2xl",children:(0,a.jsxs)("div",{className:"jsx-97ad73b43520455f p-8 flex flex-col items-center",children:[(0,a.jsx)("div",{className:"jsx-97ad73b43520455f bg-white p-6 rounded-2xl shadow-inner border-4 border-blue-100",children:E&&(0,a.jsx)(j.t,{value:E,size:280,level:"H",includeMargin:!1})}),k?(0,a.jsxs)("div",{className:"jsx-97ad73b43520455f mt-6 text-center",children:[(0,a.jsx)("div",{className:"jsx-97ad73b43520455f inline-flex items-center justify-center w-12 h-12 bg-green-100 rounded-full mb-2",children:(0,a.jsx)(b.Z,{size:24,className:"text-green-600"})}),(0,a.jsx)("p",{className:"jsx-97ad73b43520455f font-medium text-green-600",children:"認証成功！"})]}):(0,a.jsxs)("div",{className:"jsx-97ad73b43520455f mt-6 text-center",children:[(0,a.jsxs)("div",{className:"jsx-97ad73b43520455f inline-flex items-center gap-2 text-blue-600 mb-2",children:[(0,a.jsx)("div",{className:"jsx-97ad73b43520455f w-2 h-2 bg-blue-600 rounded-full animate-pulse"}),(0,a.jsx)("span",{className:"jsx-97ad73b43520455f font-medium",children:"認証待機中..."})]}),(0,a.jsx)("p",{className:"jsx-97ad73b43520455f text-sm text-gray-600",children:"ユーザーアプリでこのQRコードを読み取ってください"})]})]})}),(0,a.jsx)("div",{className:"jsx-97ad73b43520455f bg-white rounded-xl shadow-lg p-6",children:"scan"===s?(0,a.jsxs)(a.Fragment,{children:[("waiting"===r||"scanning"===r)&&(0,a.jsxs)("div",{className:"jsx-97ad73b43520455f text-center",children:[(0,a.jsx)("h2",{className:"jsx-97ad73b43520455f text-xl font-bold text-gray-900 mb-2",children:"QRコードをスキャンしてください"}),(0,a.jsx)("p",{className:"jsx-97ad73b43520455f text-gray-600 mb-4",children:"ユーザーアプリのQRコードをカメラに映してください"}),(0,a.jsxs)("div",{className:"jsx-97ad73b43520455f bg-gray-50 rounded-lg p-3 mb-4",children:[(0,a.jsx)("div",{className:"jsx-97ad73b43520455f text-xs text-gray-500 mb-1",children:"タイムアウトまで"}),(0,a.jsxs)("div",{className:"jsx-97ad73b43520455f text-2xl font-bold text-blue-600",children:[N,"秒"]})]}),(0,a.jsx)("button",{onClick:z,className:"jsx-97ad73b43520455f w-full bg-gray-100 hover:bg-gray-200 text-gray-700 py-2.5 rounded-lg font-medium transition-colors",children:"手動入力に切り替え"})]}),"success"===r&&(0,a.jsxs)("div",{className:"jsx-97ad73b43520455f text-center",children:[(0,a.jsx)("div",{className:"jsx-97ad73b43520455f inline-flex items-center justify-center w-16 h-16 bg-green-100 rounded-full mb-3",children:(0,a.jsx)(b.Z,{size:32,className:"text-green-600"})}),(0,a.jsx)("h2",{className:"jsx-97ad73b43520455f text-xl font-bold text-gray-900 mb-2",children:"読み取り成功！"}),(0,a.jsx)("p",{className:"jsx-97ad73b43520455f text-gray-600",children:"顧客情報を確認しています..."})]}),"error"===r&&(0,a.jsxs)("div",{className:"jsx-97ad73b43520455f text-center",children:[(0,a.jsx)("div",{className:"jsx-97ad73b43520455f inline-flex items-center justify-center w-16 h-16 bg-red-100 rounded-full mb-3",children:(0,a.jsx)(f.Z,{size:32,className:"text-red-600"})}),(0,a.jsx)("h2",{className:"jsx-97ad73b43520455f text-xl font-bold text-gray-900 mb-2",children:"denied"===y?"カメラへのアクセスが拒否されました":"読み取りエラー"}),(0,a.jsx)("p",{className:"jsx-97ad73b43520455f text-gray-600 mb-4",children:h||"QRコードの読み取りに失敗しました"}),(0,a.jsxs)("div",{className:"jsx-97ad73b43520455f flex flex-col gap-3",children:["denied"!==y&&(0,a.jsx)("button",{onClick:()=>{i("waiting"),p(30),g(""),window.location.reload()},className:"jsx-97ad73b43520455f w-full bg-blue-600 hover:bg-blue-700 text-white py-2.5 rounded-lg font-medium transition-colors",children:"再試行"}),(0,a.jsx)("button",{onClick:z,className:"jsx-97ad73b43520455f w-full bg-green-600 hover:bg-green-700 text-white py-2.5 rounded-lg font-medium transition-colors",children:"手動入力に切り替え"}),(0,a.jsx)("button",{onClick:q,className:"jsx-97ad73b43520455f w-full bg-gray-200 hover:bg-gray-300 text-gray-800 py-2.5 rounded-lg font-medium transition-colors",children:"キャンセル"})]})]})]}):(0,a.jsx)("div",{className:"jsx-97ad73b43520455f text-center",children:k?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("div",{className:"jsx-97ad73b43520455f inline-flex items-center justify-center w-16 h-16 bg-green-100 rounded-full mb-3",children:(0,a.jsx)(b.Z,{size:32,className:"text-green-600"})}),(0,a.jsx)("h2",{className:"jsx-97ad73b43520455f text-xl font-bold text-gray-900 mb-2",children:"認証成功！"}),(0,a.jsx)("p",{className:"jsx-97ad73b43520455f text-gray-600",children:"顧客情報を確認しています..."})]}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("h2",{className:"jsx-97ad73b43520455f text-xl font-bold text-gray-900 mb-2",children:"ユーザー認証待ち"}),(0,a.jsx)("p",{className:"jsx-97ad73b43520455f text-gray-600 mb-4",children:"ユーザーがスマートフォンでQRコードを読み取るまでお待ちください"}),(0,a.jsxs)("div",{className:"jsx-97ad73b43520455f bg-blue-50 rounded-lg p-4 mb-4",children:[(0,a.jsx)("div",{className:"jsx-97ad73b43520455f text-sm font-medium text-blue-900 mb-2",children:"\uD83D\uDCF1 ユーザーへの案内"}),(0,a.jsxs)("ol",{className:"jsx-97ad73b43520455f text-xs text-left text-blue-800 space-y-1",children:[(0,a.jsx)("li",{className:"jsx-97ad73b43520455f",children:"1. スマホでアプリを開く"}),(0,a.jsx)("li",{className:"jsx-97ad73b43520455f",children:"2. QRスキャン機能を起動"}),(0,a.jsx)("li",{className:"jsx-97ad73b43520455f",children:"3. 画面のQRコードを読み取る"})]})]}),(0,a.jsx)("button",{onClick:q,className:"jsx-97ad73b43520455f w-full bg-gray-200 hover:bg-gray-300 text-gray-800 py-2.5 rounded-lg font-medium transition-colors",children:"キャンセル"})]})})})]})}),(0,a.jsx)(n(),{id:"97ad73b43520455f",children:"#qr-reader{border:none!important}#qr-reader video{-webkit-border-radius:0!important;-moz-border-radius:0!important;border-radius:0!important;-o-object-fit:cover!important;object-fit:cover!important}#qr-reader__dashboard{display:none!important}#qr-reader__scan_region{border:none!important}"})]})]})}}},function(e){e.O(0,[7430,9204,7896,2888,9774,179],function(){return e(e.s=3924)}),_N_E=e.O()}]);