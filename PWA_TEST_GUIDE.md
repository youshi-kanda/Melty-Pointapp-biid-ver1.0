# PWA機能テストガイド

## テスト環境の準備

### 必要な環境
1. **開発サーバー**: `npm run dev` で起動
2. **HTTPSまたはlocalhost**: PWAはHTTPS環境が必須（localhostは例外）
3. **テストデバイス**:
   - iOS: iPhone (Safari)
   - Android: スマートフォン/タブレット (Chrome)
   - デスクトップ: Chrome, Edge

### 本番環境でのテスト
```bash
# ビルド
npm run build

# 本番サーバー起動（HTTPSで）
npm start
```

---

## テスト項目

### 1. ユーザーアプリPWAテスト

#### 1.1 PWAインストール確認

**Chrome（Android/Desktop）**
1. ブラウザで `https://your-domain.com/user/` にアクセス
2. アドレスバー右端に「インストール」アイコンが表示されることを確認
3. ホーム画面に3秒後にインストールプロンプトが表示されることを確認
4. 「インストール」ボタンをクリック
5. ホーム画面/アプリ一覧に「Melty+」アイコンが追加されることを確認

**Safari（iOS）**
1. Safariで `https://your-domain.com/user/` にアクセス
2. 共有ボタン（四角に上矢印）をタップ
3. 「ホーム画面に追加」を選択
4. アイコンとタイトルが表示されることを確認
5. 「追加」をタップ
6. ホーム画面に「Melty+」アイコンが追加されることを確認

**検証ポイント**:
- ✅ アイコンが正しく表示される（ピンク系グラデーション、M+）
- ✅ タイトルが「Melty+」と表示される
- ✅ インストールプロンプトが表示される（Chromeのみ）

#### 1.2 スタンドアロン起動確認

1. ホーム画面の「Melty+」アイコンをタップ
2. アプリがフルスクリーンで起動することを確認
3. ブラウザのアドレスバーが表示されないことを確認
4. ステータスバー（時計、バッテリー）のみ表示されることを確認

**検証ポイント**:
- ✅ フルスクリーン表示（display: standalone）
- ✅ ブラウザUIが非表示
- ✅ テーマカラー（ピンク#ec4899）がステータスバーに反映

#### 1.3 ショートカット機能確認

**Android（Chromeのみ）**
1. ホーム画面の「Melty+」アイコンを長押し
2. ショートカットメニューが表示されることを確認:
   - 📊 ポイント履歴
   - 🎁 ギフト交換
   - 🗺️ 店舗マップ
3. 各ショートカットをタップして該当ページに遷移することを確認

**検証ポイント**:
- ✅ 3つのショートカットが表示される
- ✅ 各ショートカットが正しいページに遷移する
- ✅ アイコンが表示される

#### 1.4 オフライン動作確認

1. アプリを一度起動し、いくつかのページを閲覧
2. デバイスを機内モードに設定
3. アプリを再起動
4. キャッシュされたページが表示されることを確認
5. 以前訪問したページに遷移できることを確認
6. APIを必要とするページでエラーメッセージが表示されることを確認

**検証ポイント**:
- ✅ 静的リソース（HTML, CSS, JS, 画像）がキャッシュから読み込まれる
- ✅ ページ遷移が可能
- ✅ オフライン時に適切なエラーメッセージが表示される

#### 1.5 キャッシュ戦略確認

**Chrome DevTools（Desktop）**
1. F12でDevToolsを開く
2. Applicationタブ → Service Workersを選択
3. Service Workerが登録されていることを確認
4. Networkタブを開く
5. ページをリロード
6. リソースの読み込み元を確認:
   - `(ServiceWorker)`: キャッシュから
   - `200`: ネットワークから

**検証ポイント**:
- ✅ API呼び出し: NetworkFirst（最新データ優先、24時間キャッシュ）
- ✅ 画像: CacheFirst（30日間キャッシュ）
- ✅ JS/CSS: StaleWhileRevalidate（7日間、バックグラウンド更新）

#### 1.6 インストールプロンプト解除機能確認

1. インストールプロンプトが表示されたら「後で」をクリック
2. ページをリロード
3. プロンプトが表示されないことを確認
4. ブラウザのDevToolsを開く
5. Application → Local Storage → `pwa-install-dismissed`キーが存在することを確認
6. 7日後に再度プロンプトが表示されることを確認（日付を変更してテスト）

**検証ポイント**:
- ✅ 「後で」クリック後にプロンプトが非表示になる
- ✅ LocalStorageに解除日時が保存される
- ✅ 7日間は再表示されない

---

### 2. 決済端末PWAテスト

#### 2.1 PWAインストール確認

**Chrome（Android Tablet）**
1. ブラウザで `https://your-domain.com/terminal/` にアクセス
2. アドレスバー右端に「インストール」アイコンが表示されることを確認
3. 「インストール」をクリック
4. ホーム画面/アプリ一覧に「Melty+ Terminal」アイコンが追加されることを確認

**検証ポイント**:
- ✅ アイコンが正しく表示される（青系グラデーション、T+）
- ✅ タイトルが「Melty+ Terminal」と表示される

#### 2.2 フルスクリーン表示確認

1. ホーム画面の「Melty+ Terminal」アイコンをタップ
2. アプリがフルスクリーン（display: fullscreen）で起動することを確認
3. ステータスバーも非表示になることを確認（Androidのみ）
4. 決済画面が最大化されることを確認

**検証ポイント**:
- ✅ 完全なフルスクリーン表示
- ✅ テーマカラー（青#667eea）がステータスバーに反映
- ✅ 横向き表示に対応

#### 2.3 ショートカット機能確認

**Android（Chromeのみ）**
1. ホーム画面の「Melty+ Terminal」アイコンを長押し
2. ショートカットメニューが表示されることを確認:
   - 📷 QRスキャン
3. ショートカットをタップしてQRスキャン画面に遷移することを確認

**検証ポイント**:
- ✅ QRスキャンショートカットが表示される
- ✅ ショートカットから直接QRスキャン画面を開ける

#### 2.4 タブレット最適化確認

1. タブレット（横向き）でアプリを起動
2. UIが横長画面に最適化されていることを確認
3. タッチターゲットが十分な大きさ（48px以上）であることを確認
4. テキストが読みやすいサイズ（16px以上）であることを確認

**検証ポイント**:
- ✅ 横向き表示で見やすいレイアウト
- ✅ タッチ操作がしやすい
- ✅ テキストが読みやすい

---

### 3. モバイル最適化テスト

#### 3.1 タッチターゲットサイズ確認

1. Chrome DevToolsを開く
2. デバイスモードに切り替え（Ctrl+Shift+M）
3. 要素を検証して各ボタン/リンクのサイズを確認
4. 最小サイズが44x44px以上であることを確認

**検証ポイント**:
- ✅ すべてのボタンが44px以上
- ✅ リンクが44px以上
- ✅ チェックボックス/ラジオボタンが24px以上（マージン込みで44px）

#### 3.2 フォントサイズ確認

1. モバイルデバイスで各入力フィールドをタップ
2. 自動ズームが発生しないことを確認（16px以上）
3. テキストが読みやすいことを確認

**検証ポイント**:
- ✅ 入力フィールドが16px以上
- ✅ 本文テキストが16px以上
- ✅ 小さいテキストが14px以上

#### 3.3 セーフエリア対応確認（iPhone X以降）

1. iPhone X以降のデバイスでアプリを起動
2. ノッチ部分が適切に処理されていることを確認
3. コンテンツがノッチに隠れていないことを確認
4. ホームインジケーター（下部のバー）にコンテンツが隠れていないことを確認

**検証ポイント**:
- ✅ safe-area-insetが適用されている
- ✅ ヘッダーがステータスバー下に表示される
- ✅ フッターがホームインジケーター上に表示される

#### 3.4 プルツーリフレッシュ無効化確認

1. PWAとして起動したアプリで画面を上方向にスワイプ
2. ブラウザのリフレッシュが発生しないことを確認
3. 通常のスクロールのみ動作することを確認

**検証ポイント**:
- ✅ overscroll-behavior-y: containが効いている
- ✅ 不要なリフレッシュが発生しない

---

### 4. Service Worker動作テスト

#### 4.1 Service Worker登録確認

**Chrome DevTools**
1. F12でDevToolsを開く
2. Applicationタブ → Service Workersを選択
3. Service Workerが登録されていることを確認
4. ステータスが「activated and is running」であることを確認

**検証ポイント**:
- ✅ Service Workerが登録されている
- ✅ スコープが `/user/` または `/terminal/`
- ✅ 更新ボタンで最新版に更新できる

#### 4.2 キャッシュ内容確認

**Chrome DevTools**
1. Applicationタブ → Cache Storageを選択
2. 以下のキャッシュが存在することを確認:
   - `workbox-precache-v2-...`: 静的リソース
   - `api-cache`: API応答
   - `image-cache`: 画像
   - `static-cache`: JS/CSS
3. 各キャッシュの内容を確認

**検証ポイント**:
- ✅ 適切なリソースがキャッシュされている
- ✅ キャッシュサイズが適切（過大でない）
- ✅ 古いキャッシュが削除される

#### 4.3 更新通知確認

1. Service Workerを更新（新しいバージョンをデプロイ）
2. アプリを開いたままにする
3. 更新通知が表示されることを確認
4. 「更新」ボタンをクリック
5. アプリが再読み込みされ、新しいバージョンが適用されることを確認

**検証ポイント**:
- ✅ 新しいService Workerの検出
- ✅ ユーザーへの通知
- ✅ スムーズな更新処理

---

## トラブルシューティング

### PWAが表示されない
- HTTPSで動作しているか確認
- manifest.jsonが正しく配信されているか確認（Content-Type: application/manifest+json）
- Service Workerが登録されているか確認
- ブラウザのキャッシュをクリア

### アイコンが表示されない
- アイコンファイルが存在するか確認（public/icons/）
- manifest.jsonのpathが正しいか確認
- 画像形式がPNGであることを確認

### オフラインで動作しない
- Service Workerが正しく登録されているか確認
- キャッシュ戦略が適切に設定されているか確認
- オフライン時のフォールバックページが設定されているか確認

### インストールプロンプトが表示されない
- `beforeinstallprompt`イベントが発火しているか確認（Chrome限定）
- すでにインストール済みでないか確認
- 最近「後で」をクリックしていないか確認（7日間非表示）

---

## 成功基準

### ユーザーアプリ
- ✅ PWAとしてインストール可能
- ✅ ホーム画面アイコンが正しく表示
- ✅ 3つのショートカットが動作
- ✅ オフラインで基本機能が利用可能
- ✅ インストールプロンプトが適切に表示
- ✅ モバイル最適化が適用されている

### 決済端末
- ✅ PWAとしてインストール可能
- ✅ フルスクリーン表示が動作
- ✅ QRスキャンショートカットが動作
- ✅ タブレット最適化が適用されている
- ✅ タッチ操作が快適

### 共通
- ✅ Service Workerが正常に動作
- ✅ キャッシュ戦略が効いている
- ✅ オフライン動作が可能
- ✅ パフォーマンスが良好（Lighthouseスコア90+）
- ✅ モバイル最適化CSS が適用されている

---

## パフォーマンステスト

### Lighthouse監査（Chrome DevTools）
1. F12でDevToolsを開く
2. Lighthouseタブを選択
3. カテゴリで「Progressive Web App」を選択
4. 「Generate report」をクリック
5. スコアを確認:
   - PWA: 90点以上
   - Performance: 90点以上
   - Accessibility: 90点以上
   - Best Practices: 90点以上
   - SEO: 90点以上

**検証ポイント**:
- ✅ PWAの要件をすべて満たしている
- ✅ 高速な読み込み（LCP < 2.5s）
- ✅ インタラクティブまでの時間が短い（FID < 100ms）
- ✅ レイアウトシフトが少ない（CLS < 0.1）

---

## 本番デプロイ前チェックリスト

- [ ] HTTPSで動作している
- [ ] manifest.jsonが正しく配信されている
- [ ] すべてのアイコンファイルが存在する
- [ ] Service Workerが登録される
- [ ] オフライン動作が可能
- [ ] インストールプロンプトが表示される
- [ ] モバイル最適化CSSが適用されている
- [ ] Lighthouseスコアが90点以上
- [ ] iOS SafariでPWAとして動作する
- [ ] Android ChromeでPWAとして動作する
- [ ] タブレットで適切に表示される
- [ ] 各ショートカットが動作する
